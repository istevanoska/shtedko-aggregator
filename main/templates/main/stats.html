{% extends 'main/header.html' %}
{% load static %}

{% block content %}
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
        <title>Статистика</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <style>
            /* Common Styles */
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 0;
                display: flex;
                flex-direction: column;
                min-height: 100vh;
                background-color: #f5f5f5;
            }

            /* Stats Page Styles */
            .stats-wrapper {
                flex: 1;
                padding: 20px;
                background-color: #f9f9f9;
            }

            .stats-container {
                max-width: 1200px;
                margin: 20px auto;
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                padding: 30px;
            }

            .stats-main-title {
                background: linear-gradient(135deg, #2e652e, #1f3f1f);
                color: white;
                padding: 15px;
                border-radius: 8px;
                text-align: center;
                font-size: 24px;
                font-weight: 600;
                margin-bottom: 30px;
            }

            .back-button {
                margin-bottom: 20px;
            }

            .back-button a {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 10px 20px;
                background-color: #f5f5f5;
                color: #2e652e;
                border-radius: 30px;
                text-decoration: none;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .back-button a:hover {
                background-color: #e0e8e0;
            }

            .stats-form {
                margin-bottom: 30px;
            }

            .form-row {
                display: flex;
                gap: 20px;
                margin-bottom: 15px;
            }

            .form-group {
                flex: 1;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 500;
                color: #2e652e;
            }

            .form-input {
                width: 100%;
                padding: 12px 15px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 16px;
                background-color: #f9f9f9;
                transition: all 0.3s ease;
            }

            .form-input:focus {
                border-color: #2e652e;
                outline: none;
                box-shadow: 0 0 8px rgba(46, 101, 46, 0.2);
            }

            .form-actions {
                text-align: center;
                margin-top: 20px;
            }

            .action-button {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 12px 25px;
                background-color: #2e652e;
                color: white;
                border: none;
                border-radius: 30px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .action-button:hover {
                background-color: #1f3f1f;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            .product-choices h3 {
                color: #2e652e;
                font-size: 20px;
                font-weight: 600;
                margin-bottom: 15px;
            }
            .price-history h3 {
                color: #2e652e;
                font-size: 20px;
                font-weight: 600;
                margin-bottom: 20px;
            }

            .no-results {
                text-align: center;
                padding: 30px;
                background-color: #fff3e0;
                border-radius: 8px;
                color: #e65100;
                border-left: 4px solid #e65100;
            }

            .no-results i {
                font-size: 40px;
                margin-bottom: 15px;
                color: #e65100;
            }

            .no-results p {
                margin: 5px 0;
                font-size: 16px;
            }

            .stats-container {
                padding: 20px;
                margin-top: 20px;
            }

            .form-row {
                flex-direction: column;
                gap: 15px;
            }

            .products-grid {
                grid-template-columns: 1fr;
            }

            /* Adjust flex layout for mobile */
            .flex-container {
                flex-direction: column !important;
                gap: 20px !important;
            }

            /* Product list adjustments */
            .products-list {
                max-width: 100% !important;
                max-height: 400px !important;
                padding: 8px !important;
            }

            .product-item {
                margin-bottom: 10px !important;
                padding-bottom: 8px !important;
            }

            .product-item img {
                width: 40px !important;
                height: 40px !important;
            }

            .product-item a {
                font-size: 14px !important;
            }

            .product-item div {
                font-size: 10px !important;
            }

            /* Chart adjustments */
            .chart-container {
            padding: 15px !important;
            }

            .chart-container h3 {
                font-size: 16px !important;
            }

            .no-results {
                padding: 20px !important;
                font-size: 14px !important;
            }

            .no-results i {
                font-size: 30px !important;
            }

            @media (max-width: 480px) {
                .stats-main-title {
                    font-size: 20px;
                    padding: 12px;
                }

                .back-button a {
                    padding: 8px 15px;
                    font-size: 14px;
                }

                .action-button {
                    padding: 10px 20px;
                    font-size: 14px;
                }

                /* Further reduce product item sizes */
                .product-item img {
                    width: 35px !important;
                    height: 35px !important;
                }

                .product-item a {
                    font-size: 13px !important;
                }

                .product-item div {
                    font-size: 9px !important;
                }

                /* Further reduce chart padding */
                .chart-container {
                    padding: 10px !important;
                }
            }
        </style>
    </head>
    <body>

    <!-- Stats Content -->
    <div class="stats-wrapper">
        <div class="stats-container">
            <div class="back-button">
                <a href="{% url 'home' %}" class="action-button">
                    <i class="fas fa-arrow-left"></i> Назад
                </a>
            </div>

            <h1 class="stats-main-title">Ценовна историја</h1>

            <form method="get" class="stats-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="store-select">Продавница:</label>
                        <select name="store" id="store-select" required class="form-input">
                            <option value="">Избери продавница...</option>
                            <option value="Vero" {% if store == "Vero" %}selected{% endif %}>Vero</option>
                            <option value="Ramstore" {% if store == "Ramstore" %}selected{% endif %}>Ramstore</option>
                            <option value="Reptil" {% if store == "Reptil" %}selected{% endif %}>Reptil</option>
                            <option value="Zito" {% if store == "Zito" %}selected{% endif %}>Zito</option>
                        </select>
                    </div>
                    <div class="form-group" style="width: 93%">
                        <label for="product-input">Продукт:</label>
                        <input type="text" id="product-input" name="query" placeholder="напр. ВОДА" required
                               value="{{ query|default:'' }}" class="form-input">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="width: 93%">
                        <label for="start-date">Од датум:</label>
                        <input type="date" id="start-date" name="start_date" class="form-input"
                               value="{{ start_date|default:'' }}">
                    </div>
                    <div class="form-group" style="width: 93%">
                        <label for="end-date">До датум:</label>
                        <input type="date" id="end-date" name="end_date" class="form-input"
                               value="{{ end_date|default:'' }}">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="action-button">
                        <i class="fas fa-chart-line"></i> Прикажи историја
                    </button>
                </div>
            </form>

            {% if similar_products and not exact_match %}
                <!-- New flex container for products and chart -->
                <div style="display: flex; gap: 30px;" class="flex-container">

                    <!-- Left: Products List -->
                    <div style="flex: 1; max-width: 400px; overflow-y: auto; max-height: 600px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fff;"
                         class="products-list">
                        <h3 style="color:#2e652e; margin-bottom: 15px;">Слични производи во {{ store }}:</h3>
                        <div>
                            {% for product, similarity in similar_products %}
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;"
                                     class="product-item">
                                    <!-- Example product image, adapt src as needed -->
                                    {#                                <img src="{{product.image_url}}" alt="{{ product }}"#}
                                    {#                                     style="width: 60px; height: 60px; object-fit: contain; border-radius: 6px; border: 1px solid #ccc;">#}
                                    <div style="flex-grow: 1;">
                                        <a href="?store={{ store|urlencode }}&query={{ query|urlencode }}&selected_product={{ product|urlencode }}"
                                           style="color: #2e652e; font-weight: 600; text-decoration: none;">
                                            {{ product }}
                                        </a>
                                        <div style="font-size: 12px; color: #666;">
                                            {#                                        {{ similarity|floatformat:2 }} сличност#}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Right: Chart -->
                    <div style="flex: 2; background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);"
                         class="chart-container" style="width: 93%">
                        {% if matched_name %}
                            <h3 style="color:#2e652e; margin-bottom: 15px;">Ценовна историја за {{ matched_name }}
                                во {{ store }}</h3>
                            <canvas id="priceChart"></canvas>
                        {% else %}
                            <div style="padding: 50px; text-align: center; color: #e65100; border: 1px solid #e65100; border-radius: 8px;"
                                 class="no-results">
                                <i class="fas fa-exclamation-circle" style="font-size: 40px; margin-bottom: 15px;"></i>
                                <p>Не се пронајдени производи за "{{ query }}" во {{ store }}.</p>
                                <p>Обидете се со различни термини или проверете го пишувањето.</p>
                            </div>
                        {% endif %}
                    </div>

                </div>
            {% endif %}

        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        {% if chart_data %}
            const ctx = document.getElementById('priceChart').getContext('2d');

            const labels = [
                {% for item in chart_data %}
                    "{{ item.date|date:'d.m.Y' }}"{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            const prices = [
                {% for item in chart_data %}
                    {{ item.price }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Цена (МКД) {{ start_date }} до {{ end_date }}',
                        data: prices,
                        borderColor: '#2e652e',
                        backgroundColor: 'rgba(46, 101, 46, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: '#333'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: '#333'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#2e652e'
                            }
                        }
                    }
                }
            });
        {% endif %}

        document.querySelector('.stats-form').addEventListener('submit', function (e) {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (startDate && endDate && startDate > endDate) {
                alert('Крајниот датум мора да биде после почетниот датум.');
                e.preventDefault();
            }
        });

        function toggleMobileMenu() {
            const menu = document.getElementById("mobile-menu");
            const overlay = document.getElementById("overlay");
            menu.classList.toggle("open");
            overlay.classList.toggle("active");
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Desktop search elements
            const searchInput = document.getElementById('searchInput');
            const suggestionsDiv = document.getElementById('suggestions');
            const searchForm = document.getElementById('searchForm');

            // Mobile search elements
            const mobileSearchInput = document.getElementById('mobileSearchInput');
            const mobileSearchForm = document.getElementById('mobileSearchForm');

            // Extended transliteration with typo correction
            function transliterateLatinToCyrillic(text) {
                const map = {
                    'dzh': 'џ', 'dzs': 'џ', 'dsh': 'џ',
                    'zh': 'ж', 'ch': 'ч', 'sh': 'ш', 'lj': 'љ', 'nj': 'њ', 'kj': 'ќ', 'dj': 'ѓ',
                    'zs': 'ж', 'hs': 'ш', 'cx': 'ч', 'sx': 'ш', 'jx': 'ж',
                    'tz': 'ц', 'ts': 'ц', 'tc': 'ц', 'dz': 'џ',
                    'a': 'а', 'b': 'б', 'v': 'в', 'g': 'г', 'd': 'д', 'e': 'е', 'z': 'з', 'i': 'и',
                    'j': 'ј', 'k': 'к', 'l': 'л', 'm': 'м', 'n': 'н', 'o': 'о', 'p': 'п', 'r': 'р',
                    's': 'с', 't': 'т', 'u': 'у', 'f': 'ф', 'h': 'х', 'c': 'ц',
                    'y': 'ј', 'w': 'в', 'x': 'кс', 'q': 'к',
                    'ia': 'ја', 'ie': 'је', 'io': 'јо', 'iu': 'ју'
                };

                const typoPatterns = [
                    {pattern: /sampon/gi, replace: 'shampon'},
                    {pattern: /cresi/gi, replace: 'creshi'},
                    {pattern: /stipki/gi, replace: 'shtipki'},
                    {pattern: /sch/gi, replace: 'sh'},
                    {pattern: /ck/gi, replace: 'k'},
                    {pattern: /ph/gi, replace: 'f'},
                    {pattern: /th/gi, replace: 't'},
                    {pattern: /([a-z]),([a-z])/gi, replace: '$1$2'},
                    {pattern: /([a-z])\.([a-z])/gi, replace: '$1$2'},
                    {pattern: /([a-z])\1/gi, replace: '$1'}
                ];

                let normalizedText = text.toLowerCase();
                for (const {pattern, replace} of typoPatterns) {
                    normalizedText = normalizedText.replace(pattern, replace);
                }

                let result = '';
                let i = 0;
                while (i < normalizedText.length) {
                    if (map[normalizedText.substring(i, i + 3)]) {
                        result += map[normalizedText.substring(i, i + 3)];
                        i += 3;
                    } else if (map[normalizedText.substring(i, i + 2)]) {
                        result += map[normalizedText.substring(i, i + 2)];
                        i += 2;
                    } else if (map[normalizedText[i]]) {
                        result += map[normalizedText[i]];
                        i++;
                    } else {
                        result += normalizedText[i];
                        i++;
                    }
                }
                return result;
            }

            function setupSearch(input, form) {
                input.addEventListener('input', function () {
                    const query = this.value.trim();
                    if (query.length < 2) {
                        suggestionsDiv.style.display = 'none';
                        return;
                    }

                    fetch(`/search-suggestions/?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            suggestionsDiv.innerHTML = '';
                            if (data.suggestions.length > 0) {
                                data.suggestions.forEach(suggestion => {
                                    const div = document.createElement('div');
                                    div.textContent = suggestion;
                                    div.style.padding = '5px 10px';
                                    div.style.cursor = 'pointer';
                                    div.addEventListener('click', function () {
                                        input.value = transliterateLatinToCyrillic(suggestion);
                                        suggestionsDiv.style.display = 'none';
                                        form.submit();
                                    });
                                    suggestionsDiv.appendChild(div);
                                });
                                suggestionsDiv.style.display = 'block';
                            } else {
                                suggestionsDiv.style.display = 'none';
                            }
                        });
                });

                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        suggestionsDiv.style.display = 'none';
                        input.value = transliterateLatinToCyrillic(input.value);
                        form.submit();
                    }
                });
            }

            setupSearch(searchInput, searchForm);
            setupSearch(mobileSearchInput, mobileSearchForm);

            document.addEventListener('click', function (e) {
                if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target) &&
                    !mobileSearchInput.contains(e.target)) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        });
    </script>
    </body>
{% endblock %}
</html>